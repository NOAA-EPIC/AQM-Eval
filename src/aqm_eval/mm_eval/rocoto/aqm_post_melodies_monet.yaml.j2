# NOTE: This file generated by "aqm-mm-eval srw-task-group". It is recommended to use that utility
#  as opposed to editing this file directly. See https://github.com/NOAA-EPIC/AQM-Eval

#tdk: remove extra whitespaces

default_aqm_task: &default_aqm
  account: '&ACCOUNT;'
  attrs:
    cycledefs: at_end
    maxtries: '1'
  envars: &default_vars
    GLOBAL_VAR_DEFNS_FP: '&GLOBAL_VAR_DEFNS_FP;'
    HOMEdir: '&HOMEdir;'
    LOGDIR:
      cyclestr:
        value:  "&LOGDIR;"
  native: {% raw %}'{{ platform.SCHED_NATIVE_CMD }}'{% endraw %}
  partition: {% raw %}'{{ "&PARTITION_DEFAULT;" if platform.get("PARTITION_DEFAULT") }}'{% endraw %}
  queue: '&QUEUE_DEFAULT;'

  {% for package in coll.members %}
task_mm_{{ package.key.value }}_prep:
  <<: *default_aqm
  command: '&LOAD_MODULES_RUN_TASK; "mm_prep" "&HOMEdir;/jobs/JSRW_AQM_MELODIES_MONET_PREP"'
  join:
    cyclestr:
      value: {% raw %}'&LOGDIR;/{{ jobname }}_@Y@m@d@H&LOGEXT;'{% endraw %}
  envars:
    <<: *default_vars
    nprocs: '{{ package.nprocs }}'
    MM_EVAL_PACKAGE: {{ package.key.value }}
  nodes: '{{ package.nodes }}'
  walltime: '{{ package.walltime }}'
  dependency:
    and:
      or:
        not:
          taskvalid:
            attrs:
              task: run_fcst_mem000
        and:
          taskvalid:
            attrs:
              task: run_fcst_mem000
          taskdep:
            attrs:
              task: run_fcst_mem000
      streq:
        left: run_package
        right: '{{ package.should_run }}'

  {% for task in package.tasks.members %}
task_mm_{{ package.key.value }}_run_{{ task.key.value }}:
  <<: *default_aqm
  command: '&LOAD_MODULES_RUN_TASK; "mm_run" "&HOMEdir;/jobs/JSRW_AQM_MELODIES_MONET_RUN"'
  join:
    cyclestr:
      value: {% raw %}'&LOGDIR;/{{ jobname }}_@Y@m@d@H&LOGEXT;'{% endraw %}
  envars:
    <<: *default_vars
    nprocs: '{{ task.nprocs }}'
    MM_EVAL_PACKAGE: '{{ package.key.value }}'
    MM_EVAL_TASK: '{{ task.key.value }}'
  nodes: '{{ task.nodes }}'
  walltime: '{{ task.walltime }}'
  dependency:
    and:
      taskdep:
        attrs:
  {% if task.key.value == "save_paired" %}
          task: mm_{{ package.key.value }}_prep
  {% else %}
          task: mm_{{ package.key.value }}_run_save_paired
  {% endif %}
      streq_task:
        left: run_task
        right: '{{ package.should_run_task[task.key] }}'
  {% if "scorecard" in task.key.value %}
      streq_scorecard:
        left: run_scorecard_task
        right: {% raw %}'{% if (melodies_monet_parm.aqm.models | length) > 1 %}run_scorecard_task{% endif %}'{% endraw %}
  {% endif %}

  {% endfor %}
  {% endfor %}
