#!/bin/bash

# This script extract/calculate necessary variables (pressfc, dew_temp, ws10m) from phy files for ISH met evaluation.
# References:
# https://nco.sourceforge.net/nco.html#Examples-ncap2
# https://unidata.github.io/MetPy/latest/api/generated/metpy.calc.dewpoint_from_specific_humidity.html
# https://library.wmo.int/records/item/41650-guide-to-instruments-and-methods-of-observation
# https://sgichuki.github.io/Atmo/

module load nco

export in_dir={{ link_base_path }}
export out_dir={{ link_Alldays_path }}
export predix={{ link_base_ish }}

cd $in_dir
dirlist=`ls -d {{ link_simulation }}`
#echo $dirlist

for dir in $dirlist
do
  dir=${dir%/}

  for fhr in $(seq -f "%02g" 1 24)
  do
    f_phy=${dir}/phyf0${fhr}.nc
    f_dyn=${dir}/dynf0${fhr}.nc
    f_out=${out_dir}/${predix}_${dir}_f0${fhr}.nc

    ncap2 -v -s 'time_iso = time_iso' $f_dyn $f_out
    ncap2 -A -v -s 'lat = lat' $f_dyn $f_out
    ncap2 -A -v -s 'lon = lon' $f_dyn $f_out
    ncap2 -A -v -s 'pfull = pfull' $f_dyn $f_out
    ncap2 -A -v -s 'phalf = phalf' $f_dyn $f_out
    ncap2 -A -v -s 'delz = delz' $f_dyn $f_out
    ncap2 -A -v -s 'dpres = dpres' $f_dyn $f_out
    ncap2 -A -v -s 'hgtsfc = hgtsfc' $f_dyn $f_out
    ncap2 -A -v -s 'pressfc = pressfc' $f_dyn $f_out
    ncap2 -A -v -s 'tmp = tmp' $f_dyn $f_out
    ncap2 -A -v -s 'tmp2m = tmp2m' $f_phy $f_out
    ncap2 -A -v -s 'vapor = (spfh2m / (1 - spfh2m)) * pressfc / (0.622 + spfh2m / (1 - spfh2m))' -s 'vapor@long_name="2 meter water vapor pressure"; vapor@units="Pa"' $f_phy $f_out
    ncap2 -A -v -s 'dew_temp = (243.5 * ln((vapor / 100) / 6.112)) / (17.269 - ln((vapor / 100) / 6.112))' -s 'dew_temp@long_name="2 meter dew point temperature"; dew_temp@units="C"' $f_out $f_out
    ncap2 -A -v -s 'ws10m = sqrt(ugrd10m * ugrd10m + vgrd10m * vgrd10m)' -s 'ws10m@long_name="10 meter wind speed"; ws10m@units="m/s"' $f_phy $f_out
    ncap2 -A -v -s 'wd10m = 270 - (atan2(vgrd10m, ugrd10m) * 180 / 3.1415)' -s 'where(wd10m > 360) wd10m = wd10m - 360' -s 'wd10m@long_name="10 meter wind direction"; wd10m@units="degree"' $f_phy $f_out

  done

  echo $dir

done
